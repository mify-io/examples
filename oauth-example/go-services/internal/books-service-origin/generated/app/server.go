// THIS FILE IS AUTOGENERATED, DO NOT EDIT
// Generated by mify
// vim: set ft=go:

package app

import (
	"fmt"
	"net/http"

	"github.com/go-chi/chi/v5"
	"go.uber.org/zap"

	"example.com/namespace/oauth-example/go-services/internal/books-service-origin/generated/core"
	"example.com/namespace/oauth-example/go-services/internal/pkg/generated/configs"
)

type ServerConf struct {
	ServerEndpoint string `envconfig:"BOOKS_SERVICE_ORIGIN_API_ENDPOINT" default:":38259"`
	MaintenanceEndpoint string `envconfig:"BOOKS_SERVICE_ORIGIN_MAINTENANCE_ENDPOINT" default:":33897"`
}

func getServerConf(conf *configs.MifyStaticConfig) *ServerConf {
	return conf.MustGetPtr((*ServerConf)(nil)).(*ServerConf)
}

func runApiServer(ctx *core.MifyServiceContext, router chi.Router) error {
	conf := getServerConf(ctx.StaticConfig())
	return runServer(ctx, "api", conf.ServerEndpoint, router)
}

func runMaintenanceServer(ctx *core.MifyServiceContext, router chi.Router) error {
	conf := getServerConf(ctx.StaticConfig())
	return runServer(ctx, "maintenance", conf.MaintenanceEndpoint, router)
}

func runServer(ctx *core.MifyServiceContext, name string, endpoint string, router chi.Router) error {
	ctx.Logger().Info(fmt.Sprintf("starting %s server", name), zap.String("endpoint", endpoint))
	err := http.ListenAndServe(endpoint, router)
	if err != nil {
		ctx.Logger().Error("failed to listen", zap.Error(err))
		return err
	}
	return nil
}
